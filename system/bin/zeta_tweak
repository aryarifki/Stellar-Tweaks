#!/system/bin/sh

Collaboration script @zeta_zimp

config_file="/data/adb/.config/stellar"
zeta_file="$config_file/zt"

zeta_tweak_apply() {
    for procstats_option in --clear --stop-testing; do dumpsys procstats "$procstats_option"; done
    for reset_pkg_ops in com.transsion.screencapture com.miui.screenrecorder com.vivo.smartshot com.mediatek.location.lppe.main com.android.location.fused; do appops reset "$reset_pkg_ops"; done
    for devconf_item in $(cmd device_config list | cut -f1 -d=); do cmd device_config delete "${devconf_item%/*}" "${devconf_item#*/}"; done
    for db_tag in system_server system_server/Subject data_app_wtf storage_trim SYSTEM_BOOT SYSTEM_AUDIT system_server_wtf SYSTEM_LAST_KMSG; do cmd dropbox add-low-priority "$db_tag"; done
    cmd dropbox set-rate-limit 99999999999999
    settings put global dropbox_age_seconds 0
    settings put global dropbox_max_files 0
    for k_safety in safety_center_is_enabled safety_center_notifications_enabled safety_center_replace_lock_screen_icon_action safety_center_show_subpages safety_center_allow_statsd_logging; do device_config put privacy "$k_safety" false; done
    device_config put privacy safety_center_allow_statsd_logging false
    current_props="$(getprop | cut -f1 -d ']')"
    eval "$(echo "$current_props" | grep -F '[log.tag' | sed 's/\[/setprop persist./g' | sed 's/$/ S/g')"
    eval "$(echo "$current_props" | grep -F '[persist.log.tag' | sed 's/\[persist./setprop /g' | sed 's/$/ S/g')"
    eval "$(echo "$current_props" | grep 'log.tag' | sed 's/\[/setprop /g' | sed 's/$/ S/g')"
    for sys_pkg in $(pm list packages -s | cut -f2 -d:); do
        am set-bg-restriction-level "$sys_pkg" hibernation
        am service-restart-backoff disable "$sys_pkg"
        am set-standby-bucket "$sys_pkg" restricted
        am kill "$sys_pkg"
        cmd app_hibernation set-state --global true "$sys_pkg"
        cmd tare set-vip 0 "$sys_pkg" false
        am set-inactive --user 0 "$sys_pkg" true
    done
    for a in $(cmd package list packages -s | cut -f2 -d:); do
        cmd media.audio_policy set-uid-state $a idle --user 0
        cmd shortcut clear-shortcuts --user 0 $a
    done
    cmd shortcut unload-user --user 0
    cmd shortcut reset-all-throttling
    for pkg_name in $(pm list packages | cut -d ":" -f2); do
        uid_val=$(dumpsys package "$pkg_name" 2>/dev/null | grep -m 1 'userId=' | sed 's/.*userId=//;s/ //g' | cut -d ' ' -f 1)
        if [ -n "$uid_val" ]; then
            cmd greezer unmonitor "$uid_val"
        fi
        am set-ignore-delivery-group-policy "$pkg_name"
        pm log-visibility --disable "$pkg_name"
        am make-uid-idle --user 0 "$pkg_name" all
        cmd ambient_context stop-detection 0 "$pkg_name"
        cmd usagestats clear-last-used-timestamps "$pkg_name" --user 0
        am clear-exit-info --user 0 all "$pkg_name"
    done
    for a in $(cmd package list packages -s | cut -f2 -d:); do cmd deviceidle whitelist -"$a"; done
    for a in $(cmd package list packages -3 | cut -f2 -d:); do cmd deviceidle whitelist +"$a"; done
    cmd deviceidle enable all
    cmd deviceidle force-idle deep
    cmd deviceidle step deep
    for f in $(dumpsys window | grep "^  Proto:" | sed 's/^  Proto: //' | tr ' ' '\n'; dumpsys window | grep "^  Logcat:" | sed 's/^  Logcat: //' | tr ' ' '\n'); do wm logging disable "$f"; wm logging disable-text "$f"; done
    cmd window logging stop
    a=$(for b in $(seq 32 126); do printf "\\x$(printf '%x' $b) "; done)
    for c in $(ps -f -o NAME); do cmd activity app-logging "$c" 0 disable-text $a; done
    cmd activity logging disable-text $(for i in $(seq 32 126); do printf "\\x$(printf '%x' $i) "; done)
    for c in $(ps -f -o NAME); do am profile stop --user 0 $c; done
    for a in $(ps -f -o UID); do cmd stats config remove $a; done
    exec 2>/dev/null
    for a in /sys/kernel/tracing/*; do for b in $(seq 100 -1 0); do echo "$b" >"$a"; done; done
    mdi_redirector_ctrl --stop-monitor
    mdi_redirector_ctrl --leave-testing-mode
    mdi_redirector_ctrl --set-payload-size 0
    bcc -enable-implicit-null-checks 1; bcc -enable-name-compression 1; bcc -stats 0; bcc -stats-json 0; bcc -verify-debug-info 0; bcc -verify-dom-info 0; bcc -verify-loop-info 0; bcc -verify-regalloc 0; bcc -verify-machine-dom-info 0; bcc -verify-region-info 0; bcc -verify-scev 0; bcc -verify-scev-maps 0; bcc -no-discriminators 1; bcc -enable-objc-arc-opts 1
    atrace --async_stop
    bmgr enable 0
    cmd accessibility stop-trace
    cmd stats clear-puller-cache
    am set-stop-user-on-switch true
    am clear-watch-heap all
    am untrack-associations
    cmd wifi set-scan-always-available disabled
    cmd wifi set-verbose-logging disabled
    cmd voiceinteraction set-debug-hotword-logging false
    cmd input_method tracing stop
    cmd connectivity set-chain3-enabled false
    cmd display set-user-disabled-hdr-types 1 2 3 4
    cmd display ab-logging-disable
    cmd display dmd-logging-disable
    cmd display dwb-logging-disable
    cmd greezer debug false
    cmd greezer enable true
    dumpsys batterystats --reset
    dumpsys batterystats --reset-all
    dumpsys batterystats disable full-history
    dumpsys batterystats disable no-auto-reset
    dumpsys batterystats enable pretend-screen-off
    cmd print set-bind-instant-service-allowed false
    cmd device_policy clear-freeze-period-record
    cmd autofill reset
    cmd autofill set log_level off
    cmd autofill set bind-instant-service-allowed false
    cmd autofill set default-augmented-service-enabled 0 false
    cmd autofill set max_visible_datasets 0
    cmd autofill set max_partitions 0
    cmd webviewupdate disable-multiprocess
    cmd companiondevice remove-associations
    cmd companiondevice clear-association-memory-cache
    cmd blob_store clear-all-sessions
    cmd blob_store clear-all-blobs
    cmd blob_store idle-maintenance
    cmd content_capture destroy sessions
    cmd content_capture set bind-instant-service-allowed false
    cmd content_capture set default-service-enabled 0 false
    cmd migard dump-trace false; cmd migard start-trace false; cmd migard stop-trace true; cmd migard trace-buffer-size 0
    cmd miui.downscale clear-debug-apps; cmd miui.downscale disable-downscale true; cmd miui.downscale set-debug-mode false
    cmd miui_embedding_window clear-fixedOri
    cmd miui_step_counter_service disable; cmd miui_step_counter_service logging-disable; cmd miui_step_counter_service set-delay 999999999; cmd miui_step_counter_service trim-all
    device_config put activity_manager use_compaction true
    device_config put adservice_system_service_enabled cobalt_logging_enabled false; device_config put adservice_system_service_enabled enable_logged_topic false; device_config put adservice_system_service_enabled adservice_error_logging_enabled false; device_config put adservice_system_service_enabled measurement_enable_app_package_name_logging false; device_config put adservice_system_service_enabled measurement_enable_source_debug_report false; device_config put adservice_system_service_enabled fledge_app_package_name_logging false; device_config put adservice_system_service_enabled fledge_auction_server_api_usage_metrics_enabled false; device_config put adservice_system_service_enabled fledge_auction_server_enabled_for_report_event false; device_config put adservice_system_service_enabled fledge_auction_server_enabled_for_report_impression false; device_config put adservice_system_service_enabled fledge_auction_server_enabled_for_select_ads_mediation false
    device_config put adservices measurement_job_aggregate_fallback_reporting_kill_switch true; device_config put adservices measurement_job_aggregate_reporting_kill_switch true; device_config put adservices measurement_job_event_fallback_reporting_kill_switch true; device_config put adservices measurement_job_event_reporting_kill_switch true
    device_config put window_manager system_gesture_exclusion_log_debounce_millis -1
    device_config put privacy safety_center_is_enabled false; device_config put privacy safety_center_notifications_enabled false; device_config put privacy safety_center_allow_statsd_logging false; device_config put privacy safety_center_show_subpages false; device_config put privacy safety_center_replace_lock_screen_icon_action false
    device_config put activity_manager bg_current_drain_auto_restrict_abusive_apps_enabled 1; device_config put activity_manager enable_app_start_info false
    device_config put adservices adservice_enabled false
    device_config put activity_manager proactive_kills_enabled true
    device_config put app_compat hidden_api_log_sampling_rate -1; device_config put app_compat hidden_api_statslog_sampling_rate -1
    device_config put device_personalization_service enable_action_boost_generator 1; device_config put device_personalization_services enable_dimensional_logging 1; device_config put device_personalization_service enable_shade_reduction_metric 1; device_config put device_personalization_service use_gpu 1; device_config put device_personalization_services use_logging_listener -1
    device_config put surface_flinger_native_boot use_skia_tracing -1
    device_config put activity_manager default_background_fgs_starts_restriction_enable true
    device_config put window_manager system_gesture_exclusion_log_debounce_millis -1
    device_config put bluetooth logging_debug_enabled_for_all false
    device_config put device_personalization_service clear_logging_events_if_too_much_memory true; device_config put device_personalization_services enable_new_logger_api false; device_config put device_personalization_service example_logging_enabled false; device_config put device_personalization_service memory_reduction true
    device_config put launcher enable_ime_latency_logger false
    device_config put odad full_killswitch true
    device_config put runtime_native_boot enable_perfetto false
    device_config put runtime_native usap_pool_enabled false
    device_config put runtime_native use_app_image_startup_cache true
    device_config put device_personalization_service enable_assistant_memory_generator true
    device_config put runtime_native_boot enable_profile_system_server false
    device_config put runtime_native_boot enable_profile_boot_class_path false
    device_config put runtime_native_boot enable_readahead false
    device_config put settings_ui event_logging_enabled false
    device_config set_sync_disabled_for_tests persistent
    dumpsys binder_calls_stats --disable
    dumpsys binder_calls_stats --disable-detailed-tracking
    logcat -P "$(pgrep * | sed 's/^/~/g')"
    logcat --wrap; logcat -G 256M; logcat -c
    settings put global binder_calls_stats "sampling_interval=600000000,detailed_tracking=disable,enabled=false,upload_data=false"
    settings put global cached_apps_freezer 1
    settings put system haptic_feedback_disable 1
    settings put secure screensaver_activate_on_dock 0
    settings put secure screensaver_enabled 0
    simpleperf --log fatal --log-to-android-buffer 0
    settings put global battery_stats_constants track_cpu_active_cluster_time=false,read_binary_cpu_time=0,proc_state_cpu_times_read_delay_ms=5000000000,kernel_uid_readers_throttle_time=1,external_stats_collection_rate_limit_ms=0,battery_level_collection_delay_ms=30000000000,max_history_buffer_kb=0,max_history_files=0
    settings put system device_idle_constants inactive_to=15000,sensing_to=0,locating_to=0,location_accuracy=20.0,motion_inactive_to=0,idle_after_inactive_to=0,idle_pending_to=60000,max_idle_pending_to=120000,idle_pending_factor=2.0,idle_to=900000,max_idle_to=86400000,idle_factor=2.0,min_time_to_alarm=600000,max_temp_app_whitelist_duration=10000
    settings put global activity_manager_constants power_check_max_cpu_1=0,power_check_max_cpu_2=0,power_check_max_cpu_3=0,power_check_max_cpu_4=0,full_pss_min_interval=216000000,full_pss_lowered_interval=216000000,kill_bg_restricted_cached_idle=true,low_swap_threshold_percent=60,proactive_kills_enabled=true,system_exempt_power_restrictions_enabled=true,kill_bg_restricted_cached_idle_settle_time=100000
    sm defragment abort
    sm idle-maint abort
    sm fstrim /cache; sm fstrim /data; sm fstrim /preload; sm fstrim /system; sm fstrim /vendor
    sm idle-maint abort >/dev/null 2>&1 &
    wm tracing level critical
    wm tracing size 0
    stop traced; stop tombstoned; stop tcpdump; stop cnss_diag; stop statsd; stop vendor.perfservice; stop logcat; stop logcatd; stop logd; stop idd-logreader; stop idd-logreadermain; stop stats; stop dumpstate; stop vendor.tcpdump; stop vendor_tcpdump; stop vendor.cnss_diag
    pm list packages -U | while read -r l; do
        p=$(echo "$l" | awk -F'[: ]' '{print $2}')
        u=$(echo "$l" | awk -F'[: ]' '{print $4}')
        [ "$p" ] && [ "$u" ] && am compact "$p" "$u" full 2>/dev/null
    done
}

zeta_tweak_reverted() {
    device_config set_sync_disabled_for_tests none
    sm fstrim
    sm idle-maint run
    sm defragment run
    for a in $(cmd package list packages | cut -d ":" -f2); do
        pm log-visibility --enable $a
    done
    for a in $(cmd package list packages -s | cut -d ":" -f2); do
        am standby-bucket active $a
        am set-bg-restriction-level $a unrestricted
        am service-restart-backoff enable $a
        am kill $a
    done
    settings put system POWER_PERFORMANCE_MODE_OPEN 0
    settings put system power_save_type_performance 0
    settings put secure breathe_gamemode_enabled 0
    settings put system speed_mode 0
    settings put secure speed_mode_enable 0
    for a in $(cmd package list packages -s | cut -f2 -d:); do
        cmd media.audio_policy set-uid-state $a active --user 0
        cmd app_hibernation set-state --global false $a
    done
    cmd set-stop-user-on-switch true
    am clear-watch-heap all
    am untrack-associations
    cmd wifi set-scan-always-available enabled
    cmd voiceinteraction set-debug-hotword-logging true
    cmd input_method tracing start
    cmd connectivity set-chain3-enabled true
    cmd wifi set-scan-always-available enabled
    cmd wifi set-verbose-logging enabled
    cmd display set-user-disabled-hdr-types 0
    cmd display ab-logging-enable
    cmd display dmd-logging-enable
    cmd display dwb-logging-enable
    cmd greezer debug true
    cmd greezer enable true
    dumpsys batterystats --reset
    dumpsys batterystats --reset-all
    dumpsys batterystats enable full-history
    dumpsys batterystats enable no-auto-reset
    dumpsys batterystats enable pretend-screen-off
    cmd print set-bind-instant-service-allowed false
    cmd autofill set bind-instant-service-allowed true
    cmd autofill set default-augmented-service-enabled 0 true
    cmd content_capture set bind-instant-service-allowed true
    cmd content_capture set default-service-enabled 0 true
    cmd migard dump-trace true; cmd migard start-trace true; cmd migard stop-trace false; cmd migard trace-buffer-size 0
    cmd miui_step_counter_service disable; cmd miui_step_counter_service logging-enable; cmd miui_step_counter_service set-delay 999999999
    settings put global cached_apps_freezer 0
    settings put system haptic_feedback_disable 0
    settings put secure screensaver_activate_on_dock 1
    settings put secure screensaver_enabled 1
    settings delete global dropbox_age_seconds
    settings delete global dropbox_max_files
    settings put global binder_calls_stats ""
    settings put system device_idle_constants ""
    settings put global activity_manager_constants ""
}

if [ ! -f "$zeta_file" ]; then
    exit 0
fi

zeta_value=$(cat "$zeta_file")

case "$1" in
    apply)
         zeta_tweak_apply ;;
    revert)
         zeta_tweak_reverted ;;
esac

exit 0